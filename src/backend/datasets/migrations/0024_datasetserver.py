# Generated by Django 4.2.13 on 2025-04-11 13:39

from django.db import migrations, models
import django.db.models.deletion


def move_storageshare_dset_newmodel(a, s):
    DS = a.get_model('datasets', 'DatasetServer')
    D = a.get_model('datasets', 'Dataset')
    for dset in D.objects.all():
        DS.objects.create(dataset=dset, storageshare=dset.storageshare, storage_loc=dset.storage_loc,
                storage_loc_ui=dset.storage_loc, startdate=dset.date, active=not dset.deleted)


def fake(a, s):
    pass


class Migration(migrations.Migration):

    dependencies = [
        ('rawstatus', '0035_servershare_active_servershare_description'),
        ('datasets', '0023_datasetserver_projectlog_remove_dataset_storageshare_and_more'),
    ]

    operations = [
        migrations.CreateModel(
            name='DatasetServer',
            fields=[
                ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('storage_loc', models.TextField()),
                ('storage_loc_ui', models.TextField()),
                ('startdate', models.DateTimeField()),
                ('active', models.BooleanField(default=True)),
                ('log', models.JSONField(default=list)),
                ('dataset', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='datasets.dataset')),
                ('storageshare', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='rawstatus.servershare')),
            ],
        ),

        migrations.AddConstraint(
            model_name='datasetserver',
            constraint=models.UniqueConstraint(fields=('storageshare', 'storage_loc'), name='uni_dsloc'),
        ),
        migrations.AddConstraint(
            model_name='datasetserver',
            constraint=models.UniqueConstraint(fields=('dataset', 'storageshare'), name='uni_dsshare'),
        ),
        migrations.AddConstraint(
            model_name='datasetserver',
            constraint=models.UniqueConstraint(fields=('storageshare', 'storage_loc_ui'), name='uni_dsloc_ui'),
        ),
        migrations.AddField(
            model_name='datasetserver',
            name='last_date_used',
            field=models.DateTimeField(auto_now=True),
        ),

        migrations.RunPython(move_storageshare_dset_newmodel, fake),

        #migrations.AlterField(
        #    model_name='dataset',
        #    name='securityclass',
        #    field=models.IntegerField(choices=[(1, 'Not classified'), (2, 'Personal data'), (3, 'Sensitive data')]),
        #),
    ]
